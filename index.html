<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="Gest√£o de Produ√ß√£o - Embaresa PT">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Produ√ß√£o - Embaresa PT</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f1f5f9; min-height: 100vh; }
        input, select, button, textarea { font-size: 16px !important; font-family: inherit; }
        select { background: white; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; }
        .btn-secondary { background: #e2e8f0; color: #475569; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; }
        .input:focus { border-color: #1e40af; }
        .label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .text-center { text-align: center; }
        .mb-3 { margin-bottom: 15px; }
        .mb-4 { margin-bottom: 20px; }
        .mt-3 { margin-top: 15px; }

        /* Modal dia terminado */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.55);
            backdrop-filter: blur(4px); z-index: 999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            animation: fadeIn .2s ease;
        }
        .modal-box {
            background: white; border-radius: 20px; padding: 32px 28px;
            width: 100%; max-width: 380px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            animation: slideUp .25s ease;
        }
        .modal-box h2 { font-size: 22px; color: #1e40af; margin: 0 0 8px 0; }
        .modal-box p { color: #64748b; font-size: 14px; margin: 0 0 28px 0; line-height: 1.5; }
        .modal-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all .2s; margin-bottom: 10px; }
        .modal-btn:active { transform: scale(0.98); }
        .modal-btn-yes { background: linear-gradient(135deg, #059669, #047857); color: white; }
        .modal-btn-no { background: linear-gradient(135deg, #1e40af, #1e3a8a); color: white; }
        .modal-btn-later { background: #f1f5f9; color: #64748b; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ============================================================
        // CONFIGURA√á√ÉO - URLs do Power Automate
        // ============================================================
        const CONFIG = {
            URL_PRODUCAO: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8c8cb9f38df4489eaa2ebd6afcdab255/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jMin9p5_ZxITDMuRcm2PeH8LlrC6SxeM_hNTLRfn-CI',
            URL_PERTURBACOES: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/971c47b2c0f34fcb87a4d2915ec0b866/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jenqnDFyXmVuQjtfGbm6PF-gNDUoF-KTu-RJoAX25k4',
            URL_CONFIG: 'https://defaultcade90c14fe343a3860494c20418f8.fb.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/464482ea19714e50b858771991c0539d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H29XBCpPy1dyMk7Gyj6LAWy8RKI8Q4mpUFdI5qanNKU'
        };

        // ============================================================
        // DADOS - Colaboradores (com ID para PIN)
        // ============================================================
        const COLABORADORES_LISTA = [
            { id: 1,  nm: "Am√≠lcar Manuel Monginho Barreto",  sh: "Am√≠lcar Barreto" },
            { id: 2,  nm: "Andr√© Avelino Tavares Rocha",      sh: "Andr√© Rocha" },
            { id: 3,  nm: "David Alexandre Lopes Rocha",      sh: "David Rocha" },
            { id: 4,  nm: "Fernando Garcia",                  sh: "Fernando Garcia" },
            { id: 5,  nm: "Hugo Jos√© Ferreira da Silva",      sh: "Hugo Silva" },
            { id: 6,  nm: "Joaquim Comenda",                  sh: "Joaquim Comenda" },
            { id: 7,  nm: "Nuno Rafael Pereira Franco",       sh: "Nuno Franco" },
            { id: 8,  nm: "Paulo Saramago",                   sh: "Paulo Saramago" },
            { id: 9,  nm: "Pedro Miguel Serranito Familia",   sh: "Pedro Familia" },
            { id: 10, nm: "Rui Miguel Charrua Rich√°u",        sh: "Rui Rich√°u" },
            { id: 11, nm: "Valdir Tavares",                   sh: "Valdir Tavares" },
            { id: 12, nm: "William Chaves Inaba",             sh: "William Inaba" },
        ];

        // Compatibilidade com c√≥digo existente (lista de nomes completos)
        const COLABORADORES = COLABORADORES_LISTA.map(c => c.nm);

        // ============================================================
        // PINs - 4 d√≠gitos por colaborador
        // ============================================================
        const DEFAULT_PINS = {
            1: '9012', 2: '4444', 3: '6666', 4: '7777',
            5: '1234', 6: '5678', 7: '1111', 8: '3333',
            9: '8888', 10: '9999', 11: '5555', 12: '2222'
        };

        // ============================================================
        // DADOS - Artigos por tipo
        // ============================================================
        const ARTIGOS = [
            { artigo: "E2-Lower Dir V2", tipo: "E2" },
            { artigo: "E2-Lower Esq V2", tipo: "E2" },
            { artigo: "E2-Upper Dir V2", tipo: "E2" },
            { artigo: "E2-Upper Esq V2", tipo: "E2" },
            { artigo: "KC 390-Lower Dir", tipo: "KC390" },
            { artigo: "KC 390-Lower Esq", tipo: "KC390" },
            { artigo: "KC 390-Upper Dir", tipo: "KC390" },
            { artigo: "KC 390-Upper Esq", tipo: "KC390" },
            { artigo: "KC 390-EV", tipo: "KC390" },
            { artigo: "KC 390-EH", tipo: "KC390" },
            { artigo: "Praetor-Semi Asa Dir", tipo: "Praetor" },
            { artigo: "Praetor-Semi Asa Esq", tipo: "Praetor" },
            { artigo: "Praetor-EH", tipo: "Praetor" },
            { artigo: "Praetor-EV", tipo: "Praetor" },
            { artigo: "Praetor-TC", tipo: "Praetor" },
            { artigo: "Caixa para Ailerons", tipo: "Praetor" },
            { artigo: "Caixa para Porta Carga", tipo: "Praetor" },
            { artigo: "Caixa para Porta Rat", tipo: "Praetor" },
            { artigo: "Caixa para Spoilers", tipo: "Praetor" },
            { artigo: "E2-Cx1 Desc 4Metros", tipo: "E2-Frac" },
            { artigo: "E2-Frac 2", tipo: "E2-Frac" },
            { artigo: "E2-Frac 7", tipo: "E2-Frac" },
            { artigo: "E2-Frac 8", tipo: "E2-Frac" },
            { artigo: "E2-Frac 9", tipo: "E2-Frac" },
            { artigo: "E2-Frac 10", tipo: "E2-Frac" },
            { artigo: "E2-Frac 11", tipo: "E2-Frac" },
            { artigo: "E2-Frac 12", tipo: "E2-Frac" },
            { artigo: "E2-Frac 22", tipo: "E2-Frac" },
            { artigo: "KC 390-Frac 2", tipo: "KC390-Frac" },
            { artigo: "KC 390-Frac 4", tipo: "KC390-Frac" },
            { artigo: "KC 390-Frac 6", tipo: "KC390-Frac" },
            { artigo: "KC 390-Frac 13", tipo: "KC390-Frac" },
            { artigo: "KC 390-Wing tip", tipo: "KC390-Frac" },
            { artigo: "E1-Embalagem A", tipo: "E1-Frac" },
            { artigo: "E1-Embalagem F", tipo: "E1-Frac" },
            { artigo: "E1-Embalagem G", tipo: "E1-Frac" },
            { artigo: "E1-Embalagem NMF", tipo: "E1-Frac" },
            { artigo: "Cxs sobras refor√ßadas", tipo: "Maquinacao" },
            { artigo: "Cxs sobras tipo jaula 1200", tipo: "Maquinacao" },
            { artigo: "Cxs sobras tipo jaula 1600", tipo: "Maquinacao" },
            { artigo: "Cxs sobras tipo jaula 1600x1200x800", tipo: "Maquinacao" },
            { artigo: "Transporte", tipo: "Transporte" }
        ];

        // ============================================================
        // DADOS - Tipos/Programas
        // ============================================================
        const TIPOS = [
            { id: "E2", nome: "E2", icon: "‚úàÔ∏è" },
            { id: "E2-Frac", nome: "E2 - Fra√ß√µes", icon: "üì¶" },
            { id: "KC390", nome: "KC390", icon: "‚úàÔ∏è" },
            { id: "KC390-Frac", nome: "KC390 - Fra√ß√µes", icon: "üì¶" },
            { id: "Praetor", nome: "Praetor", icon: "‚úàÔ∏è" },
            { id: "E1-Frac", nome: "E1 - Fra√ß√µes", icon: "üì¶" },
            { id: "Maquinacao", nome: "Maquina√ß√£o", icon: "‚öôÔ∏è" },
            { id: "Transporte", nome: "Transportes", icon: "üöõ" }
        ];

        // ============================================================
        // DADOS - Opera√ß√µes
        // ============================================================
        const OPERACOES = [
            // E2
            { op: "E2- Soldadura Integral do bastidor", unidade: "Evora1-Soldadura", artigos: ["E2-Lower Dir V2", "E2-Lower Esq V2", "E2-Upper Dir V2", "E2-Upper Esq V2"] },
            { op: "E2- Coloca√ß√£o de fundo e patins", unidade: "Evora1-Montagem", artigos: ["E2-Lower Dir V2", "E2-Lower Esq V2", "E2-Upper Dir V2", "E2-Upper Esq V2"] },
            { op: "E2-Montagem e revestimento integral de suportes", unidade: "Evora1-Montagem", artigos: ["E2-Lower Dir V2", "E2-Lower Esq V2", "E2-Upper Dir V2", "E2-Upper Esq V2"] },
            { op: "E2-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["E2-Lower Dir V2", "E2-Lower Esq V2", "E2-Upper Dir V2", "E2-Upper Esq V2"] },
            { op: "E2-Montagem de suportes, topos, coloca√ß√£o de lona e armazenagem", unidade: "Evora1-Montagem", artigos: ["E2-Lower Dir V2", "E2-Lower Esq V2", "E2-Upper Dir V2", "E2-Upper Esq V2"] },
            { op: "E2- Embalamento", unidade: "Evora1-Embalamento", artigos: ["E2-Lower Dir V2", "E2-Lower Esq V2", "E2-Upper Dir V2", "E2-Upper Esq V2"] },
            // KC390
            { op: "KC390-Soldadura Integral bastidor", unidade: "Evora1-Soldadura", artigos: ["KC 390-Lower Dir", "KC 390-Lower Esq", "KC 390-Upper Dir", "KC 390-Upper Esq"] },
            { op: "KC390-Montagem caixa", unidade: "Evora1-Montagem", artigos: ["KC 390-Lower Dir", "KC 390-Lower Esq", "KC 390-Upper Dir", "KC 390-Upper Esq"] },
            { op: "KC390 asa-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["KC 390-Lower Dir", "KC 390-Lower Esq", "KC 390-Upper Dir", "KC 390-Upper Esq"] },
            { op: "KC390-Fundo e Patins", unidade: "Evora1-Montagem", artigos: ["KC 390-Lower Dir", "KC 390-Lower Esq", "KC 390-Upper Dir", "KC 390-Upper Esq"] },
            { op: "KC390-Revestimento e armazenagem", unidade: "Evora1-Montagem", artigos: ["KC 390-Lower Dir", "KC 390-Lower Esq", "KC 390-Upper Dir", "KC 390-Upper Esq"] },
            { op: "KC 390-Embalamento", unidade: "Evora1-Embalamento", artigos: ["KC 390-Lower Dir", "KC 390-Lower Esq", "KC 390-Upper Dir", "KC 390-Upper Esq"] },
            { op: "KC390 EV-Montagem caixa", unidade: "Evora1-Montagem", artigos: ["KC 390-EV"] },
            { op: "KC390 EV-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["KC 390-EV"] },
            { op: "KC390 EV-Embalamento", unidade: "Evora1-Embalamento", artigos: ["KC 390-EV"] },
            { op: "KC390 EH-Montagem caixa", unidade: "Evora1-Montagem", artigos: ["KC 390-EH"] },
            { op: "KC390 EH-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["KC 390-EH"] },
            { op: "KC390 EH-Embalamento", unidade: "Evora1-Embalamento", artigos: ["KC 390-EH"] },
            // Praetor
            { op: "Praetor Semi asa- Soldadura Integral do bastidor", unidade: "Evora1-Soldadura", artigos: ["Praetor-Semi Asa Dir", "Praetor-Semi Asa Esq"] },
            { op: "Praetor Semi asa-Montagem de suportes, topos, coloca√ß√£o de lona e armazenagem", unidade: "Evora1-Montagem", artigos: ["Praetor-Semi Asa Dir", "Praetor-Semi Asa Esq"] },
            { op: "Praetor Semi asa-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["Praetor-Semi Asa Dir", "Praetor-Semi Asa Esq"] },
            { op: "Praetor Semi asa-Embalamento", unidade: "Evora1-Embalamento", artigos: ["Praetor-Semi Asa Dir", "Praetor-Semi Asa Esq"] },
            { op: "Praetor EH-Montagem", unidade: "Evora1-Montagem", artigos: ["Praetor-EH"] },
            { op: "Praetor EH-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["Praetor-EH"] },
            { op: "Praetor EH-Embalamento", unidade: "Evora1-Embalamento", artigos: ["Praetor-EH"] },
            { op: "Praetor EV- Montagem caixa", unidade: "Evora1-Montagem", artigos: ["Praetor-EV"] },
            { op: "Praetor EV-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["Praetor-EV"] },
            { op: "Praetor EV- Embalamento", unidade: "Evora1-Embalamento", artigos: ["Praetor-EV"] },
            { op: "Montagem caixa Tail cone", unidade: "Evora1-Montagem", artigos: ["Praetor-TC"] },
            { op: "Praetor TC-Prepara√ß√£o de Bolsa de alum√≠nio", unidade: "Evora1-Montagem", artigos: ["Praetor-TC"] },
            { op: "Embalamento Tail cone", unidade: "Evora1-Embalamento", artigos: ["Praetor-TC"] },
            // Fra√ß√µes
            { op: "E2-Frac-Prepara√ß√£o e Montagem", unidade: "√âvora 2-Montagem", artigos: ["E2-Cx1 Desc 4Metros", "E2-Frac 2", "E2-Frac 7", "E2-Frac 8", "E2-Frac 9", "E2-Frac 10", "E2-Frac 11", "E2-Frac 12", "E2-Frac 22"] },
            { op: "KC390-Frac-Prepara√ß√£o e Montagem", unidade: "√âvora 2-Montagem", artigos: ["KC 390-Frac 2", "KC 390-Frac 4", "KC 390-Frac 6", "KC 390-Frac 13", "KC 390-Wing tip"] },
            { op: "E1-Prepara√ß√£o e Montagem", unidade: "√âvora 2-Montagem", artigos: ["E1-Embalagem A", "E1-Embalagem F", "E1-Embalagem G", "E1-Embalagem NMF"] },
            { op: "Prepara√ß√£o e Montagem Cx sobras", unidade: "√âvora 2-Montagem", artigos: ["Cxs sobras refor√ßadas", "Cxs sobras tipo jaula 1600x1200x800", "Cxs sobras tipo jaula 1600", "Cxs sobras tipo jaula 1200"] },
            { op: "Carga e Transporte de caixas para ANN/EMBARESA2", unidade: "Transportes", artigos: ["Transporte"] }
        ];

        // ============================================================
        // DADOS - Perturba√ß√µes
        // ============================================================
        const PERTURBACOES = [
            "Atraso entrega de pe√ßa no cliente",
            "Avaria Maquina de soldar",
            "Avaria Equipamentos",
            "Avaria/ Manuten√ß√£o ponte rolante",
            "Descarga cami√£o material",
            "Falha electricidade",
            "Falha leitura do plano/ material errado",
            "Falta de Pessoal",
            "Falta material de embalagem",
            "Forma√ß√£o / 1¬™pe√ßa/ Try outs",
            "Forma√ß√£o on the Job",
            "Forma√ß√£o/Reuni√£o/ analise planeamento vs objectivos",
            "Limpeza cami√£o",
            "Limpeza e prepara√ß√£o material para soldadura",
            "Limpeza/ Organiza√ß√£o",
            "Manuten√ß√£o/ limpeza Programada",
            "Material de embalagem Fora de dimens√µes",
            "Movimenta√ß√£o de material/ Produto acabado",
            "Movimenta√ß√£o residuos para destinat√°rio reciclagem",
            "Organiza√ß√£o & Movimenta√ß√£o de material",
            "Prepara√ß√£o arranque/ fim e para cliente",
            "Prepara√ß√£o material - soldadura",
            "Prepara√ß√£o material para stock de semiacabados Frac√ß√µes",
            "Prepara√ß√£o material para stock de semiacabados E2",
            "Problemas de esquadria - madeira torcida",
            "Produto n√£o conforme",
            "Produto n√£o conforme no cliente",
            "Produto para Semi-Acabado",
            "Repara√ß√£o de lona rasgada",
            "Repara√ß√£o produto n√£o conforme para cliente",
            "Separa√ß√£o de material para montagem",
            "Tempo espera no cliente-Recep√ßao /Caixa/ Pe√ßa/Qualidade"
        ];

        // ============================================================
        // DADOS - Feriados
        // ============================================================
        const FERIADOS = ['01-01','04-25','05-01','06-10','06-29','08-15','10-05','11-01','12-01','12-08','12-25'];

        // ============================================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // ============================================================
        const calcDuracao = (i, f) => {
            if (!i || !f) return '';
            const [hi, mi] = i.split(':').map(Number);
            const [hf, mf] = f.split(':').map(Number);
            let m = (hf * 60 + mf) - (hi * 60 + mi);
            if (m < 0) m += 1440;
            return Math.floor(m / 60) + 'h ' + (m % 60) + 'min';
        };

        const calcMin = (i, f) => {
            if (!i || !f) return 0;
            const [hi, mi] = i.split(':').map(Number);
            const [hf, mf] = f.split(':').map(Number);
            let m = (hf * 60 + mf) - (hi * 60 + mi);
            return m < 0 ? m + 1440 : m;
        };

        const formatData = d => d ? d.split('-').reverse().join('/') : '';
        const eFeriado = d => FERIADOS.includes(d.slice(5));
        const eFimDeSemana = d => { const dia = new Date(d + 'T12:00:00').getDay(); return dia === 0 || dia === 6; };

        const enviarPowerAutomate = async (url, dados) => {
            if (!url || url.includes('xxx')) {
                console.log('Power Automate n√£o configurado:', dados);
                return true;
            }
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                return true;
            } catch (e) {
                console.log('Enviado (CORS):', dados);
                return true;
            }
        };

        // ============================================================
        // COMPONENTE APP
        // ============================================================
        const App = () => {
            // Estados
            const [view, setView] = useState('menu');
            const [operador, setOperador] = useState(localStorage.getItem('operadorProd') || '');
            const [loggedIn, setLoggedIn] = useState(!!localStorage.getItem('operadorProd'));
            const [loading, setLoading] = useState(false);
            const [dataAtual, setDataAtual] = useState(new Date().toISOString().split('T')[0]);

            // Estados PIN
            const [pins] = useState(() => JSON.parse(localStorage.getItem('prod_pins') || 'null') || {...DEFAULT_PINS});
            const [selEmp, setSelEmp] = useState(null);
            const [pinDigits, setPinDigits] = useState(['', '', '', '']);
            const [pinError, setPinError] = useState(false);
            const [showDiaModal, setShowDiaModal] = useState(false);
            const [avisoRegistosAbertos, setAvisoRegistosAbertos] = useState(null); // {data, totalMin}

            const [registos, setRegistos] = useState(() => {
                const s = localStorage.getItem('registosProd');
                return s ? JSON.parse(s) : [];
            });

            const [perturbacoes, setPerturbacoes] = useState(() => {
                const s = localStorage.getItem('perturbacoesProd');
                return s ? JSON.parse(s) : [];
            });

            const [registo, setRegisto] = useState({
                data: dataAtual, tipo: '', artigo: '', operacao: '', unidade: '',
                horaInicio: '', horaFim: '', comentarios: ''
            });

            const [pert, setPert] = useState({
                data: dataAtual, tipo: '', horaInicio: '', horaFim: ''
            });

            // Estados para configura√ß√µes din√¢micas (carregadas do Excel)
            const [programasLista, setProgramasLista] = useState(TIPOS);
            const [artigosLista, setArtigosLista] = useState(ARTIGOS);
            const [operacoesLista, setOperacoesLista] = useState(OPERACOES);
            const [perturbsLista, setPerturbsLista] = useState(PERTURBACOES);
            const [colaboradoresLista, setColaboradoresLista] = useState(COLABORADORES);
            const [configLoaded, setConfigLoaded] = useState(false);
            const [configError, setConfigError] = useState('');

            // Carregar configura√ß√µes do Excel via Power Automate
            useEffect(() => {
                const carregarConfigs = async () => {
                    // Verificar cache local (v√°lido por 1 hora)
                    const cache = localStorage.getItem('configCache');
                    const cacheTime = localStorage.getItem('configCacheTime');
                    if (cache && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
                        try {
                            const dados = JSON.parse(cache);
                            aplicarConfigs(dados);
                            setConfigLoaded(true);
                            console.log('‚úÖ Configs carregadas do cache');
                            return;
                        } catch(e) {}
                    }

                    // Buscar do Power Automate
                    if (!CONFIG.URL_CONFIG || CONFIG.URL_CONFIG.includes('xxx')) {
                        console.log('‚ö†Ô∏è URL_CONFIG n√£o configurado, usando dados locais');
                        setConfigLoaded(true);
                        return;
                    }

                    try {
                        const resp = await fetch(CONFIG.URL_CONFIG, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ acao: 'lerConfigs' })
                        });
                        
                        if (resp.ok) {
                            const dados = await resp.json();
                            aplicarConfigs(dados);
                            // Guardar em cache
                            localStorage.setItem('configCache', JSON.stringify(dados));
                            localStorage.setItem('configCacheTime', Date.now().toString());
                            console.log('‚úÖ Configs carregadas do Excel');
                        }
                    } catch(e) {
                        console.log('‚ö†Ô∏è Erro ao carregar configs, usando dados locais:', e.message);
                        setConfigError('Offline - usando dados locais');
                    }
                    setConfigLoaded(true);
                };

                const aplicarConfigs = (dados) => {
                    // Se o flow devolver um array plano, organizar por tipo de item
                    if (Array.isArray(dados)) {
                        const dadosOrganizados = {
                            programas: dados.filter(i => i.ID && i.Nome && i.Icon),
                            artigos: dados.filter(i => i.Artigo && i.Programa && !i.Operacao),
                            operacoes: dados.filter(i => i.Operacao && i.Unidade && i.Artigos),
                            perturbacoes: dados.filter(i => i.Perturbacao),
                            colaboradores: dados.filter(i => i.Nome && i.Turno && i.Ativo)
                        };
                        aplicarConfigs(dadosOrganizados);
                        return;
                    }

                    // ConfigProgramas
                    if (dados.programas && Array.isArray(dados.programas) && dados.programas.length > 0) {
                        const progs = dados.programas.map(p => ({
                            id: p.ID || p.id,
                            nome: p.Nome || p.nome,
                            icon: p.Icon || p.icon || 'üì¶'
                        })).filter(p => p.id);
                        if (progs.length > 0) setProgramasLista(progs);
                    }

                    // ConfigArtigos
                    if (dados.artigos && Array.isArray(dados.artigos) && dados.artigos.length > 0) {
                        const arts = dados.artigos.map(a => ({
                            artigo: a.Artigo || a.artigo,
                            tipo: a.Programa || a.programa || a.Tipo || a.tipo
                        })).filter(a => a.artigo);
                        if (arts.length > 0) setArtigosLista(arts);
                    }

                    // ConfigOperacoes
                    if (dados.operacoes && Array.isArray(dados.operacoes) && dados.operacoes.length > 0) {
                        const ops = dados.operacoes.map(o => ({
                            op: o.Operacao || o.op,
                            unidade: o.Unidade || o.unidade || '',
                            programa: o.Programa || o.programa || '',
                            artigos: typeof (o.Artigos || o.artigos) === 'string' 
                                ? (o.Artigos || o.artigos).split(',').map(a => a.trim()).filter(a => a)
                                : (o.Artigos || o.artigos || [])
                        })).filter(o => o.op);
                        if (ops.length > 0) setOperacoesLista(ops);
                    }

                    // ConfigPerturbacoes
                    if (dados.perturbacoes && Array.isArray(dados.perturbacoes) && dados.perturbacoes.length > 0) {
                        const perts = dados.perturbacoes.map(p => p.Perturbacao || p.perturbacao || p.Descricao || p).filter(p => p && typeof p === 'string');
                        if (perts.length > 0) setPerturbsLista(perts);
                    }

                    // ConfigColaboradores
                    if (dados.colaboradores && Array.isArray(dados.colaboradores) && dados.colaboradores.length > 0) {
                        const cols = dados.colaboradores
                            .filter(c => (c.Ativo || c.ativo || '').toLowerCase() === 'sim')
                            .map(c => c.Nome || c.nome)
                            .filter(c => c);
                        if (cols.length > 0) setColaboradoresLista(cols);
                    }
                };

                carregarConfigs();
            }, []);

            // For√ßar recarga das configs
            const recarregarConfigs = () => {
                localStorage.removeItem('configCache');
                localStorage.removeItem('configCacheTime');
                setConfigLoaded(false);
                setConfigError('');
                window.location.reload();
            };

            // Persist√™ncia
            useEffect(() => { localStorage.setItem('registosProd', JSON.stringify(registos)); }, [registos]);
            useEffect(() => { localStorage.setItem('perturbacoesProd', JSON.stringify(perturbacoes)); }, [perturbacoes]);

            // Tipos/Programas din√¢micos - usa programas do Excel, com fallback
            const tiposDinamicos = useMemo(() => {
                const tiposComArtigos = [...new Set(artigosLista.map(a => a.tipo))];
                return tiposComArtigos.map(t => {
                    const prog = programasLista.find(x => x.id === t);
                    return prog || { id: t, nome: t, icon: 'üì¶' };
                });
            }, [artigosLista, programasLista]);

            // Filtros
            const artigosFilt = useMemo(() => 
                registo.tipo ? artigosLista.filter(a => a.tipo === registo.tipo) : []
            , [registo.tipo, artigosLista]);

            const opsFilt = useMemo(() => 
                registo.artigo ? operacoesLista.filter(o => o.artigos.includes(registo.artigo)) : []
            , [registo.artigo, operacoesLista]);

            const regsDia = useMemo(() => 
                registos.filter(r => r.data === dataAtual && r.colaborador === operador)
            , [registos, dataAtual, operador]);

            const pertsDia = useMemo(() => 
                perturbacoes.filter(p => p.data === dataAtual && p.colaborador === operador)
            , [perturbacoes, dataAtual, operador]);

            // Totais
            const totais = useMemo(() => {
                let mp = 0, mpt = 0;
                regsDia.forEach(r => mp += calcMin(r.horaInicio, r.horaFim));
                pertsDia.forEach(p => mpt += calcMin(p.horaInicio, p.horaFim));
                return { ops: regsDia.length, perts: pertsDia.length, tempoProd: mp, tempoPert: mpt, total: mp + mpt };
            }, [regsDia, pertsDia]);

            // Resumo por tipo
            const resumoPorTipo = useMemo(() => {
                const r = {};
                regsDia.forEach(reg => {
                    const art = artigosLista.find(a => a.artigo === reg.artigo);
                    const t = art?.tipo || 'Outro';
                    if (!r[t]) r[t] = { ops: 0, min: 0 };
                    r[t].ops++;
                    r[t].min += calcMin(reg.horaInicio, reg.horaFim);
                });
                return r;
            }, [regsDia, artigosLista]);

            // Login/Logout com PIN
            const pickEmp = (emp) => {
                setSelEmp(emp);
                setPinDigits(['', '', '', '']);
                setPinError(false);
                setTimeout(() => {
                    const el = document.getElementById('pin0');
                    if (el) el.focus();
                }, 100);
            };

            const handlePinInput = (i, val, allDigits) => {
                if (!/^\d?$/.test(val)) return;
                const d = [...allDigits];
                d[i] = val;
                setPinDigits(d);
                if (val && i < 3) {
                    setTimeout(() => {
                        const el = document.getElementById('pin' + (i + 1));
                        if (el) el.focus();
                    }, 10);
                }
                if (val && i === 3) {
                    const fullPin = d.join('');
                    if (fullPin.length === 4) doLoginPin(selEmp, fullPin);
                }
            };

            const handlePinKeyDown = (i, e) => {
                if (e.key === 'Backspace' && !pinDigits[i] && i > 0) {
                    const el = document.getElementById('pin' + (i - 1));
                    if (el) el.focus();
                }
            };

            const doLoginPin = (emp, pin) => {
                if (!emp || pin.length !== 4) return;
                if (pins[emp.id] !== pin) {
                    setPinError(true);
                    setPinDigits(['', '', '', '']);
                    setTimeout(() => {
                        const el = document.getElementById('pin0');
                        if (el) el.focus();
                    }, 10);
                    return;
                }
                // Verificar registos em aberto de dias anteriores
                const hoje = new Date().toISOString().split('T')[0];
                const regsGuardados = JSON.parse(localStorage.getItem('registosProd') || '[]');
                const pertsGuardados = JSON.parse(localStorage.getItem('perturbacoesProd') || '[]');
                // Agrupar por dia, apenas dias anteriores a hoje
                const diasAnteriores = {};
                [...regsGuardados, ...pertsGuardados]
                    .filter(r => r.colaborador === emp.nm && r.data < hoje)
                    .forEach(r => {
                        if (!diasAnteriores[r.data]) diasAnteriores[r.data] = 0;
                        const [hi, mi] = (r.horaInicio||'0:0').split(':').map(Number);
                        const [hf, mf] = (r.horaFim||'0:0').split(':').map(Number);
                        let m = (hf*60+mf)-(hi*60+mi);
                        if (m < 0) m += 1440;
                        diasAnteriores[r.data] += m;
                    });
                // Verificar se h√° algum dia com menos de 450 min (7h30) ‚Äî excluir fins de semana
                const diasIncompletos = Object.entries(diasAnteriores)
                    .filter(([d, min]) => min < 450 && !eFimDeSemana(d))
                    .sort((a, b) => b[0].localeCompare(a[0])); // mais recente primeiro
                localStorage.setItem('operadorProd', emp.nm);
                setOperador(emp.nm);
                setLoggedIn(true);
                setPinError(false);
                if (diasIncompletos.length > 0) {
                    const [dataInc, minInc] = diasIncompletos[0];
                    setAvisoRegistosAbertos({ data: dataInc, totalMin: minInc });
                }
            };

            const login = () => {
                const fullPin = pinDigits.join('');
                if (selEmp && fullPin.length === 4) doLoginPin(selEmp, fullPin);
            };

            const logout = () => {
                localStorage.removeItem('operadorProd');
                setOperador('');
                setLoggedIn(false);
                setSelEmp(null);
                setPinDigits(['', '', '', '']);
                setPinError(false);
                setView('menu');
            };

            // Adicionar registo
            const addRegisto = async () => {
                if (!registo.artigo || !registo.operacao || !registo.horaInicio || !registo.horaFim) {
                    alert('Preencha todos os campos obrigat√≥rios!');
                    return;
                }

                if (eFeriado(registo.data) && !confirm(formatData(registo.data) + ' √© feriado. Continuar?')) return;

                setLoading(true);
                const id = Date.now();
                const dur = calcDuracao(registo.horaInicio, registo.horaFim);
                const art = artigosLista.find(a => a.artigo === registo.artigo);

                const novo = {
                    id,
                    data: registo.data,
                    artigo: registo.artigo,
                    tipoCaixa: art?.tipo || '',
                    operacao: registo.operacao,
                    unidade: registo.unidade,
                    colaborador: operador,
                    horaInicio: registo.horaInicio,
                    horaFim: registo.horaFim,
                    duracao: dur,
                    comentarios: registo.comentarios,
                    dataHora: new Date().toLocaleString('pt-PT'),
                    synced: false
                };

                // Enviar para Power Automate
                const enviado = await enviarPowerAutomate(CONFIG.URL_PRODUCAO, {
                    ID: id.toString(),
                    Data: registo.data,
                    Artigo: registo.artigo,
                    TipoCaixa: art?.tipo || '',
                    Operacao: registo.operacao,
                    UnidadeProducao: registo.unidade,
                    Colaborador: operador,
                    HoraInicio: registo.horaInicio,
                    HoraFim: registo.horaFim,
                    Duracao: dur,
                    Comentarios: registo.comentarios || '',
                    DataHoraRegisto: new Date().toLocaleString('pt-PT')
                });

                novo.synced = enviado;
                setRegistos([...registos, novo]);

                setRegisto({
                    ...registo,
                    artigo: '', operacao: '', unidade: '',
                    horaInicio: registo.horaFim, horaFim: '', comentarios: ''
                });

                setLoading(false);
                setShowDiaModal(true);
            };

            // Adicionar perturba√ß√£o
            const addPert = async () => {
                if (!pert.tipo || !pert.horaInicio || !pert.horaFim) {
                    alert('Preencha todos os campos!');
                    return;
                }

                setLoading(true);
                const id = Date.now();
                const dur = calcDuracao(pert.horaInicio, pert.horaFim);

                const nova = {
                    id,
                    data: pert.data,
                    tipo: pert.tipo,
                    colaborador: operador,
                    horaInicio: pert.horaInicio,
                    horaFim: pert.horaFim,
                    duracao: dur,
                    dataHora: new Date().toLocaleString('pt-PT'),
                    synced: false
                };

                const enviado = await enviarPowerAutomate(CONFIG.URL_PERTURBACOES, {
                    IDRegisto: id.toString(),
                    Data: pert.data,
                    Colaborador: operador,
                    TipoPerturbacao: pert.tipo,
                    HoraInicio: pert.horaInicio,
                    HoraFim: pert.horaFim,
                    Duracao: dur,
                    DataHoraRegisto: new Date().toLocaleString('pt-PT')
                });

                nova.synced = enviado;
                setPerturbacoes([...perturbacoes, nova]);

                setPert({ ...pert, tipo: '', horaInicio: pert.horaFim, horaFim: '' });
                setLoading(false);
                setShowDiaModal(true);
            };

            // ============================================================
            // MODAL - AVISO REGISTOS EM ABERTO
            // ============================================================
            const ModalAvisoAberto = () => {
                if (!avisoRegistosAbertos) return null;
                const { data, totalMin } = avisoRegistosAbertos;
                const [d, m, a] = data.split('-').reverse();
                const dataFmt = d + '/' + m + '/' + a;
                const h = Math.floor(totalMin / 60);
                const min = totalMin % 60;
                const hoje = new Date().toISOString().split('T')[0];
                const dataFmtHoje = hoje.split('-').reverse().join('/');
                return (
                    <div className="modal-overlay">
                        <div className="modal-box">
                            <div style={{ fontSize: '52px', marginBottom: '12px' }}>‚ö†Ô∏è</div>
                            <h2 style={{ color: '#d97706' }}>Registos em aberto</h2>
                            <p>
                                No dia <strong>{dataFmt}</strong> ficaram registos por completar.<br/>
                                Total registado: <strong>{h}h {min}min</strong> (m√≠n. 7h30)<br/><br/>
                                Tens de completar os registos antes de avan√ßar.
                            </p>
                            <button className="modal-btn" style={{ background: 'linear-gradient(135deg, #d97706, #b45309)', color: 'white' }}
                                onClick={() => {
                                    setDataAtual(data);
                                    setAvisoRegistosAbertos(null);
                                }}>
                                üìù Completar registos de {dataFmt}
                            </button>
                        </div>
                    </div>
                );
            };

            // ============================================================
            // MODAL - DIA TERMINADO?
            // ============================================================
            const ModalDia = () => {
                const [fase, setFase] = useState(1);

                const terminarDia = () => {
                    setShowDiaModal(false);
                    logout();
                };

                const continuarRegisto = () => {
                    setShowDiaModal(false);
                    setView('menu');
                };

                return (
                    <div className="modal-overlay">
                        <div className="modal-box">
                            {fase === 1 ? (
                                <>
                                    <div style={{ fontSize: '52px', marginBottom: '12px' }}>üèÅ</div>
                                    <h2>Registo guardado!</h2>
                                    <p>O dia de trabalho est√° terminado?</p>
                                    <button className="modal-btn modal-btn-yes" onClick={terminarDia}>
                                        ‚úÖ Sim, encerrar dia
                                    </button>
                                    <button className="modal-btn modal-btn-no" onClick={() => setFase(2)}>
                                        ‚ûï N√£o, tenho mais para registar
                                    </button>
                                </>
                            ) : (
                                <>
                                    <div style={{ fontSize: '52px', marginBottom: '12px' }}>üìã</div>
                                    <h2>O que pretendes fazer?</h2>
                                    <p>Continua a registar ou deixa para mais tarde.</p>
                                    <button className="modal-btn modal-btn-no" onClick={continuarRegisto}>
                                        üì¶ Continuar a registar
                                    </button>
                                    <button className="modal-btn modal-btn-later" onClick={terminarDia}>
                                        üïê Terminar mais tarde
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            // ============================================================
            // ECR√É LOGIN COM PIN
            // ============================================================
            if (!loggedIn) {
                const pinStyle = (i) => ({
                    width: '56px', height: '64px', textAlign: 'center', fontSize: '28px',
                    fontWeight: '700', border: '2px solid ' + (pinError ? '#dc2626' : '#e2e8f0'),
                    borderRadius: '12px', outline: 'none', background: pinError ? '#fef2f2' : '#f8fafc',
                    color: '#1e40af', transition: 'all .2s'
                });
                return (
                    <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
                        <div className="card" style={{ width: '100%', maxWidth: '420px', padding: '28px' }}>
                            <div className="text-center mb-4">
                                <div style={{ fontSize: '56px', marginBottom: '10px' }}>üè≠</div>
                                <h1 style={{ fontSize: '22px', color: '#1e40af', margin: '0 0 4px 0' }}>Registo de Produ√ß√£o</h1>
                                <p style={{ color: '#64748b', margin: 0, fontSize: '14px' }}>Embaresa PT ‚Äî √âvora</p>
                            </div>

                            {/* Lista de colaboradores */}
                            <div style={{ marginBottom: '16px' }}>
                                <label className="label">üë§ Selecionar colaborador</label>
                                <div style={{ maxHeight: '260px', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                    {COLABORADORES_LISTA.map(emp => (
                                        <div key={emp.id}
                                            onClick={() => pickEmp(emp)}
                                            style={{
                                                padding: '12px 16px', border: '2px solid ' + (selEmp?.id === emp.id ? '#1e40af' : '#e2e8f0'),
                                                borderRadius: '10px', cursor: 'pointer', background: selEmp?.id === emp.id ? '#eff6ff' : '#f8fafc',
                                                display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                                transition: 'all .15s', fontSize: '14px', fontWeight: selEmp?.id === emp.id ? '600' : '400'
                                            }}>
                                            <span>{emp.sh}</span>
                                            {selEmp?.id === emp.id && <span style={{ color: '#1e40af' }}>‚úì</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Entrada de PIN */}
                            {selEmp && (
                                <div>
                                    <label className="label" style={{ textAlign: 'center', display: 'block', marginBottom: '12px' }}>
                                        üîë PIN de {selEmp.sh.split(' ')[0]}
                                    </label>
                                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'center', marginBottom: '12px' }}>
                                        {[0,1,2,3].map(i => (
                                            <input
                                                key={i}
                                                id={'pin' + i}
                                                type="tel"
                                                maxLength={1}
                                                value={pinDigits[i]}
                                                onChange={e => handlePinInput(i, e.target.value, pinDigits)}
                                                onKeyDown={e => handlePinKeyDown(i, e)}
                                                style={pinStyle(i)}
                                            />
                                        ))}
                                    </div>
                                    {pinError && (
                                        <div style={{ textAlign: 'center', color: '#dc2626', fontSize: '13px', marginBottom: '12px' }}>
                                            ‚ùå PIN incorreto. Tenta novamente.
                                        </div>
                                    )}
                                    <button className="btn btn-primary" style={{ width: '100%', padding: '14px', fontSize: '16px' }} onClick={login}>
                                        Entrar ‚ûî
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // ============================================================
            // ECR√É OPERA√á√ÉO
            // ============================================================
            if (view === 'operacao') {
                return (
                    <div style={{ minHeight: '100vh', background: '#f1f5f9' }}>
                        {avisoRegistosAbertos && <ModalAvisoAberto />}
                        {showDiaModal && <ModalDia />}
                        <div style={{ background: 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)', color: 'white', padding: '20px', paddingTop: '40px' }}>
                            <button className="btn btn-secondary" style={{ marginBottom: '15px' }} onClick={() => setView('menu')}>‚Üê Voltar</button>
                            <h1 style={{ margin: 0, fontSize: '22px' }}>üì¶ Registar Opera√ß√£o</h1>
                            <p style={{ margin: '5px 0 0 0', opacity: 0.9, fontSize: '14px' }}>{operador}</p>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div className="card">
                                <div className="mb-3">
                                    <label className="label">üìÖ Data</label>
                                    <input type="date" className="input" value={registo.data} onChange={e => setRegisto({ ...registo, data: e.target.value })} />
                                </div>

                                <div className="mb-3">
                                    <label className="label">üè≠ Programa</label>
                                    <select className="input" value={registo.tipo} onChange={e => setRegisto({ ...registo, tipo: e.target.value, artigo: '', operacao: '', unidade: '' })}>
                                        <option value="">Selecionar...</option>
                                        {tiposDinamicos.map(t => <option key={t.id} value={t.id}>{t.icon} {t.nome}</option>)}
                                    </select>
                                </div>

                                <div className="mb-3">
                                    <label className="label">üì¶ Artigo</label>
                                    <select className="input" value={registo.artigo} onChange={e => setRegisto({ ...registo, artigo: e.target.value, operacao: '', unidade: '' })} disabled={!registo.tipo}>
                                        <option value="">{registo.tipo ? 'Selecionar...' : 'Selecione programa primeiro'}</option>
                                        {artigosFilt.map((a, i) => <option key={i} value={a.artigo}>{a.artigo}</option>)}
                                    </select>
                                </div>

                                <div className="mb-3">
                                    <label className="label">üîß Opera√ß√£o</label>
                                    <select className="input" value={registo.operacao} onChange={e => {
                                        const o = operacoesLista.find(x => x.op === e.target.value);
                                        setRegisto({ ...registo, operacao: e.target.value, unidade: o?.unidade || '' });
                                    }} disabled={!registo.artigo}>
                                        <option value="">{registo.artigo ? 'Selecionar...' : 'Selecione artigo primeiro'}</option>
                                        {opsFilt.map((o, i) => <option key={i} value={o.op}>{o.op}</option>)}
                                    </select>
                                    {registo.unidade && (
                                        <div style={{ marginTop: '8px', padding: '8px 12px', background: '#eff6ff', borderRadius: '8px', fontSize: '13px', color: '#1e40af' }}>
                                            üìç {registo.unidade}
                                        </div>
                                    )}
                                </div>

                                <div className="mb-3">
                                    <label className="label">‚è±Ô∏è Hor√°rio</label>
                                    <div className="grid-2">
                                        <div>
                                            <label style={{ fontSize: '12px', color: '#64748b' }}>In√≠cio</label>
                                            <input type="time" className="input" value={registo.horaInicio} onChange={e => setRegisto({ ...registo, horaInicio: e.target.value })} />
                                        </div>
                                        <div>
                                            <label style={{ fontSize: '12px', color: '#64748b' }}>Fim</label>
                                            <input type="time" className="input" value={registo.horaFim} onChange={e => setRegisto({ ...registo, horaFim: e.target.value })} />
                                        </div>
                                    </div>
                                    {registo.horaInicio && registo.horaFim && (
                                        <div style={{ marginTop: '10px', padding: '10px', background: '#dcfce7', borderRadius: '8px', textAlign: 'center', fontWeight: '700', color: '#059669' }}>
                                            Dura√ß√£o: {calcDuracao(registo.horaInicio, registo.horaFim)}
                                        </div>
                                    )}
                                </div>

                                <div className="mb-4">
                                    <label className="label">üí¨ Coment√°rios (opcional)</label>
                                    <textarea className="input" rows={2} value={registo.comentarios} onChange={e => setRegisto({ ...registo, comentarios: e.target.value })} placeholder="Observa√ß√µes..." />
                                </div>

                                <button className="btn btn-success" style={{ width: '100%', padding: '16px', fontSize: '18px' }} onClick={addRegisto} disabled={loading}>
                                    {loading ? '‚è≥ A guardar...' : '‚úì Registar Opera√ß√£o'}
                                </button>
                            </div>

                            {regsDia.length > 0 && (
                                <div className="card">
                                    <h3 style={{ margin: '0 0 15px 0' }}>Opera√ß√µes de hoje ({regsDia.length})</h3>
                                    {regsDia.sort((a, b) => a.horaInicio.localeCompare(b.horaInicio)).map(r => (
                                        <div key={r.id} style={{ background: '#f1f5f9', borderRadius: '10px', padding: '12px', marginBottom: '8px', borderLeft: '4px solid #1e40af' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: '#1e40af', fontWeight: '600' }}>{r.horaInicio} - {r.horaFim} ({r.duracao})</div>
                                                    <div style={{ fontWeight: '600' }}>{r.artigo}</div>
                                                    <div style={{ fontSize: '12px', color: '#64748b' }}>{r.operacao}</div>
                                                </div>
                                                <button style={{ background: '#fee2e2', border: 'none', color: '#dc2626', padding: '6px 10px', borderRadius: '6px', cursor: 'pointer' }} onClick={() => {
                                                    if (confirm('Eliminar este registo?')) setRegistos(registos.filter(x => x.id !== r.id));
                                                }}>üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // ============================================================
            // ECR√É PERTURBA√á√ÉO
            // ============================================================
            if (view === 'perturbacao') {
                return (
                    <div style={{ minHeight: '100vh', background: '#fef2f2' }}>
                        {showDiaModal && <ModalDia />}
                        <div style={{ background: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)', color: 'white', padding: '20px', paddingTop: '40px' }}>
                            <button className="btn" style={{ background: 'rgba(255,255,255,0.2)', marginBottom: '15px' }} onClick={() => setView('menu')}>‚Üê Voltar</button>
                            <h1 style={{ margin: 0, fontSize: '22px' }}>‚ö†Ô∏è Registar Perturba√ß√£o</h1>
                            <p style={{ margin: '5px 0 0 0', opacity: 0.9, fontSize: '14px' }}>{operador}</p>
                        </div>
                        <div style={{ padding: '20px' }}>
                            <div className="card">
                                <div className="mb-3">
                                    <label className="label">üìÖ Data</label>
                                    <input type="date" className="input" value={pert.data} onChange={e => setPert({ ...pert, data: e.target.value })} />
                                </div>

                                <div className="mb-3">
                                    <label className="label">Tipo de Perturba√ß√£o</label>
                                    <select className="input" value={pert.tipo} onChange={e => setPert({ ...pert, tipo: e.target.value })}>
                                        <option value="">Selecionar...</option>
                                        {perturbsLista.map((p, i) => <option key={i} value={p}>{p}</option>)}
                                    </select>
                                </div>

                                <div className="mb-4">
                                    <label className="label">‚è±Ô∏è Hor√°rio</label>
                                    <div className="grid-2">
                                        <div>
                                            <label style={{ fontSize: '12px', color: '#64748b' }}>In√≠cio</label>
                                            <input type="time" className="input" style={{ borderColor: '#fecaca' }} value={pert.horaInicio} onChange={e => setPert({ ...pert, horaInicio: e.target.value })} />
                                        </div>
                                        <div>
                                            <label style={{ fontSize: '12px', color: '#64748b' }}>Fim</label>
                                            <input type="time" className="input" style={{ borderColor: '#fecaca' }} value={pert.horaFim} onChange={e => setPert({ ...pert, horaFim: e.target.value })} />
                                        </div>
                                    </div>
                                    {pert.horaInicio && pert.horaFim && (
                                        <div style={{ marginTop: '10px', padding: '10px', background: '#fef2f2', borderRadius: '8px', textAlign: 'center', fontWeight: '700', color: '#dc2626' }}>
                                            Dura√ß√£o: {calcDuracao(pert.horaInicio, pert.horaFim)}
                                        </div>
                                    )}
                                </div>

                                <button className="btn btn-danger" style={{ width: '100%', padding: '16px', fontSize: '18px' }} onClick={addPert} disabled={loading}>
                                    {loading ? '‚è≥ A guardar...' : '‚úì Registar Perturba√ß√£o'}
                                </button>
                            </div>

                            {pertsDia.length > 0 && (
                                <div className="card">
                                    <h3 style={{ margin: '0 0 15px 0', color: '#dc2626' }}>Perturba√ß√µes de hoje ({pertsDia.length})</h3>
                                    {pertsDia.map(p => (
                                        <div key={p.id} style={{ background: '#fef2f2', borderRadius: '10px', padding: '12px', marginBottom: '8px', borderLeft: '4px solid #dc2626' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: '#dc2626', fontWeight: '600' }}>{p.horaInicio} - {p.horaFim} ({p.duracao})</div>
                                                    <div style={{ fontWeight: '600', color: '#b91c1c' }}>{p.tipo}</div>
                                                </div>
                                                <button style={{ background: '#fee2e2', border: 'none', color: '#dc2626', padding: '6px 10px', borderRadius: '6px', cursor: 'pointer' }} onClick={() => {
                                                    if (confirm('Eliminar esta perturba√ß√£o?')) setPerturbacoes(perturbacoes.filter(x => x.id !== p.id));
                                                }}>üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // ============================================================
            // ECR√É RESUMO
            // ============================================================
            if (view === 'resumo') {
                return (
                    <div style={{ minHeight: '100vh', background: '#f1f5f9' }}>
                        <div style={{ background: 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)', color: 'white', padding: '20px', paddingTop: '40px' }}>
                            <button className="btn" style={{ background: 'rgba(255,255,255,0.2)', marginBottom: '15px' }} onClick={() => setView('menu')}>‚Üê Voltar</button>
                            <h1 style={{ margin: 0, fontSize: '22px' }}>üìä Resumo do Dia</h1>
                            <p style={{ margin: '5px 0 0 0', opacity: 0.9, fontSize: '14px' }}>{formatData(dataAtual)} - {operador}</p>
                        </div>
                        <div style={{ padding: '20px' }}>
                            {/* Totais */}
                            <div className="grid-2 mb-3">
                                <div className="card text-center">
                                    <div style={{ fontSize: '32px', fontWeight: '700', color: '#1e40af' }}>{totais.ops}</div>
                                    <div style={{ fontSize: '12px', color: '#64748b' }}>Opera√ß√µes</div>
                                </div>
                                <div className="card text-center">
                                    <div style={{ fontSize: '32px', fontWeight: '700', color: '#dc2626' }}>{totais.perts}</div>
                                    <div style={{ fontSize: '12px', color: '#64748b' }}>Perturba√ß√µes</div>
                                </div>
                            </div>

                            <div className="grid-2 mb-4">
                                <div className="card text-center">
                                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#059669' }}>
                                        {Math.floor(totais.tempoProd / 60)}h {totais.tempoProd % 60}min
                                    </div>
                                    <div style={{ fontSize: '12px', color: '#64748b' }}>Tempo Produ√ß√£o</div>
                                </div>
                                <div className="card text-center">
                                    <div style={{ fontSize: '24px', fontWeight: '700', color: '#7c3aed' }}>
                                        {Math.floor(totais.total / 60)}h {totais.total % 60}min
                                    </div>
                                    <div style={{ fontSize: '12px', color: '#64748b' }}>Tempo Total</div>
                                </div>
                            </div>

                            {/* Resumo por tipo */}
                            {Object.keys(resumoPorTipo).length > 0 && (
                                <div className="card">
                                    <h3 style={{ margin: '0 0 15px 0' }}>üì¶ Por Tipo de Caixa</h3>
                                    {Object.entries(resumoPorTipo).map(([tipo, d]) => {
                                        const t = tiposDinamicos.find(x => x.id === tipo);
                                        return (
                                            <div key={tipo} style={{ background: '#f1f5f9', borderRadius: '10px', padding: '12px', marginBottom: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <div>
                                                    <div style={{ fontWeight: '600' }}>{t?.icon} {t?.nome || tipo}</div>
                                                    <div style={{ fontSize: '12px', color: '#64748b' }}>{d.ops} opera√ß√µes</div>
                                                </div>
                                                <div style={{ fontWeight: '700', color: '#1e40af' }}>
                                                    {Math.floor(d.min / 60)}h {d.min % 60}min
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Lista de opera√ß√µes */}
                            {regsDia.length > 0 && (
                                <div className="card">
                                    <h3 style={{ margin: '0 0 15px 0' }}>üìã Opera√ß√µes</h3>
                                    {regsDia.sort((a, b) => a.horaInicio.localeCompare(b.horaInicio)).map((r, i) => (
                                        <div key={r.id} style={{ padding: '10px 0', borderBottom: i < regsDia.length - 1 ? '1px solid #e2e8f0' : 'none' }}>
                                            <div style={{ fontSize: '12px', color: '#1e40af', fontWeight: '600' }}>{r.horaInicio} - {r.horaFim}</div>
                                            <div style={{ fontWeight: '600' }}>{r.artigo}</div>
                                            <div style={{ fontSize: '12px', color: '#64748b' }}>{r.operacao}</div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Lista de perturba√ß√µes */}
                            {pertsDia.length > 0 && (
                                <div className="card">
                                    <h3 style={{ margin: '0 0 15px 0', color: '#dc2626' }}>‚ö†Ô∏è Perturba√ß√µes</h3>
                                    {pertsDia.map((p, i) => (
                                        <div key={p.id} style={{ padding: '10px 0', borderBottom: i < pertsDia.length - 1 ? '1px solid #e2e8f0' : 'none' }}>
                                            <div style={{ fontSize: '12px', color: '#dc2626', fontWeight: '600' }}>{p.horaInicio} - {p.horaFim}</div>
                                            <div style={{ fontWeight: '600', color: '#b91c1c' }}>{p.tipo}</div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Mensagem se vazio */}
                            {regsDia.length === 0 && pertsDia.length === 0 && (
                                <div className="card text-center" style={{ padding: '40px' }}>
                                    <div style={{ fontSize: '48px', marginBottom: '15px' }}>üì≠</div>
                                    <p style={{ color: '#64748b', margin: 0 }}>Sem registos para este dia</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // ============================================================
            // MENU PRINCIPAL
            // ============================================================
            return (
                <div style={{ minHeight: '100vh', background: '#f1f5f9' }}>
                    {/* Modal aviso registos abertos */}
                    {avisoRegistosAbertos && <ModalAvisoAberto />}
                    {/* Modal dia terminado */}
                    {showDiaModal && <ModalDia />}
                    {/* Header */}
                    <div style={{ background: 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)', color: 'white', padding: '20px', paddingTop: '40px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h1 style={{ margin: 0, fontSize: '22px' }}>üè≠ Registo Produ√ß√£o</h1>
                                <p style={{ margin: '5px 0 0 0', opacity: 0.9, fontSize: '14px' }}>{operador}</p>
                            </div>
                            <button className="btn" style={{ background: 'rgba(255,255,255,0.2)' }} onClick={() => setView('resumo')}>üìä</button>
                        </div>

                        {/* Seletor de data */}
                        <div style={{ marginTop: '15px', padding: '10px 15px', background: 'rgba(255,255,255,0.15)', borderRadius: '10px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <span>üìÖ</span>
                            <input 
                                type="date" 
                                value={dataAtual} 
                                onChange={e => {
                                    setDataAtual(e.target.value);
                                    setRegisto({ ...registo, data: e.target.value });
                                    setPert({ ...pert, data: e.target.value });
                                }}
                                style={{ background: 'transparent', border: 'none', color: 'white', fontSize: '16px', fontWeight: '600' }}
                            />
                        </div>
                    </div>

                    <div style={{ padding: '20px' }}>
                        {/* Totais do dia */}
                        {(totais.ops > 0 || totais.perts > 0) && (
                            <div className="grid-2 mb-3">
                                <div className="card text-center" style={{ padding: '15px' }}>
                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#1e40af' }}>{totais.ops}</div>
                                    <div style={{ fontSize: '11px', color: '#64748b' }}>Opera√ß√µes</div>
                                </div>
                                <div className="card text-center" style={{ padding: '15px' }}>
                                    <div style={{ fontSize: '28px', fontWeight: '700', color: '#dc2626' }}>{totais.perts}</div>
                                    <div style={{ fontSize: '11px', color: '#64748b' }}>Perturba√ß√µes</div>
                                </div>
                            </div>
                        )}

                        {/* Indicador de horas */}
                        {totais.total > 0 && (
                            <div className="card mb-3" style={{ 
                                background: totais.total >= 450 ? '#dcfce7' : totais.total >= 360 ? '#fef3c7' : '#fee2e2',
                                border: '2px solid ' + (totais.total >= 450 ? '#059669' : totais.total >= 360 ? '#f59e0b' : '#dc2626')
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <span style={{ fontSize: '24px' }}>{totais.total >= 450 ? '‚úÖ' : '‚è∞'}</span>
                                    <div>
                                        <div style={{ fontWeight: '700', color: totais.total >= (eFimDeSemana(dataAtual) ? 1 : 450) ? '#059669' : totais.total >= 360 ? '#92400e' : '#dc2626' }}>
                                            {eFimDeSemana(dataAtual)
                                                ? (totais.total > 0 ? 'Hor√°rio livre ‚úì' : '')
                                                : (totais.total >= 450 ? 'Dia completo!' : 'Faltam ' + Math.floor((480 - totais.total) / 60) + 'h ' + ((480 - totais.total) % 60) + 'min')}
                                        </div>
                                        <div style={{ fontSize: '12px', color: '#64748b' }}>
                                            Total: {Math.floor(totais.total / 60)}h {totais.total % 60}min{eFimDeSemana(dataAtual) ? ' (fim de semana)' : ' / 8h'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Bot√£o Opera√ß√£o */}
                        <button className="btn btn-primary mb-3" style={{ width: '100%', padding: '20px', fontSize: '18px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }} onClick={() => setView('operacao')}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                <span style={{ fontSize: '30px' }}>üì¶</span>
                                <div style={{ textAlign: 'left' }}>
                                    <div>Registar Opera√ß√£o</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, fontWeight: '400' }}>Artigo, opera√ß√£o, tempo</div>
                                </div>
                            </div>
                            <span>‚Üí</span>
                        </button>

                        {/* Bot√£o Perturba√ß√£o */}
                        <button className="btn btn-danger mb-3" style={{ width: '100%', padding: '20px', fontSize: '18px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }} onClick={() => setView('perturbacao')}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                <span style={{ fontSize: '30px' }}>‚ö†Ô∏è</span>
                                <div style={{ textAlign: 'left' }}>
                                    <div>Registar Perturba√ß√£o</div>
                                    <div style={{ fontSize: '12px', opacity: 0.8, fontWeight: '400' }}>Paragens, avarias, etc.</div>
                                </div>
                            </div>
                            <span>‚Üí</span>
                        </button>

                        {/* Bot√£o Resumo */}
                        <button className="btn btn-secondary mb-4" style={{ width: '100%', padding: '16px' }} onClick={() => setView('resumo')}>
                            üìä Ver Resumo do Dia
                        </button>

                        {/* Alterar colaborador */}
                        <button className="btn" style={{ width: '100%', background: 'transparent', color: '#64748b' }} onClick={logout}>
                            üîÑ Alterar colaborador
                        </button>

                        {/* Recarregar configura√ß√µes */}
                        <button className="btn" style={{ width: '100%', background: 'transparent', color: '#94a3b8', fontSize: '13px', marginTop: '10px' }} onClick={recarregarConfigs}>
                            üîÑ Atualizar configura√ß√µes do Excel
                        </button>

                        {configError && (
                            <div style={{ textAlign: 'center', fontSize: '12px', color: '#f59e0b', marginTop: '8px' }}>
                                ‚ö†Ô∏è {configError}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
